<%- include ../partials/header.ejs %>
<%- include ../partials/navbar.ejs %>
<%- include ../partials/sidebar.ejs %>

<div id="kt_app_toolbar" class="py-3 py-lg-6">
  <div id="kt_app_toolbar_container" class="app-container">
    <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
      <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0"> <%= title %> </h1>
      <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
        <li class="breadcrumb-item text-muted"> <a href="/" class="text-muted text-hover-primary">Home</a> </li>
        <li class="breadcrumb-item"> <span class="bullet bg-gray-400 w-5px h-2px"></span> </li>
        <li class="breadcrumb-item text-muted"> <a href="/notadinas" class="text-muted text-hover-primary">Nota Dinas</a> </li>
        <li class="breadcrumb-item"> <span class="bullet bg-gray-400 w-5px h-2px"></span> </li>
        <li class="breadcrumb-item text-muted"><%= title %></li>
      </ul>
    </div>
    <div class="card shadow-sm mt-5">
      <div class="card-body">
        <div class="mb-5">
          <div class="row">
            <div class="col-md-6">

              <div class="mb-5 hover-scroll-x">
                <div class="d-grid">
                  <ul class="nav nav-tabs flex-nowrap text-nowrap">
                    <li class="nav-item">
                      <a class="nav-link active btn btn-active-light btn-color-gray-600 btn-active-color-primary rounded-bottom-0" data-bs-toggle="tab" href="#kt_tab_pane_1">Kepala Surat</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link  btn btn-active-light btn-color-gray-600 btn-active-color-primary rounded-bottom-0" data-bs-toggle="tab" href="#kt_tab_pane_2">Isi Surat</a>
                    </li>
                  </ul>
                </div>
              </div>

              <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="kt_tab_pane_1" role="tabpanel">
                  <form>
                    <div class="form-group mb-5">
                      <label class="required form-label">Kepada</label>
                      <select class="form-select form-select-solid" id="kepada" name="kepada" data-control="select2" data-placeholder="Dikirimkan kepada" data-allow-clear="true">
                        <option value="">Dikirimkan kepada</option>
                        <% users.forEach(user=> { %>
                        <option value="<%= user.username %>">
                          <%= user.username %> - <%= user.jabatan %>/<%= user.divisi %>
                        </option>
                        <% }) %>
                      </select>
                    </div>
                    <div class="form-group mb-5">
                      <label class="required form-label"> Dari</label>
                      <input type="text" id="dari" name="dari" class="form-control" value="<%= username %>" />
                    </div>
                    <div class="form-group row mb-5">
                      <label class="required form-label" for="sifat">Sifat</label>
                      <div class="col-sm-8">
                        <select class="form-select form-select-solid" name="sifat" id="sifat" data-control="select2" data-placeholder="Pilih sifat" data-allow-clear="true">
                          <option></option>
                          <option value="Segera">Segera</option>
                          <option value="Amat Segera">Amat Segera
                          </option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group row mb-5">
                      <label class="required form-label"> Lampiran</label>
                      <div class="col-sm-4">
                        <input type="number" class="form-control" id="jumlah-lampiran" name="" value="1">
                      </div>
                      <div class="col-sm-4">
                        <select class=" form-control form-select form-select-solid" name="" id="tipe-lampiran" data-control="select2" data-placeholder="Lampiran" data-allow-clear="true">
                          <option></option>
                          <option value="Lembar">Lembar</option>
                          <option value="Berkas">Berkas</option>
                          <option value="Halaman">Halaman</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group mb-3">
                      <label class="required form-label">Hal</label>
                      <textarea type="textarea" id="perihal" name="perihal" class="form-control"></textarea>
                    </div>
                  </form>
                </div>
                <div class="tab-pane fade" id="kt_tab_pane_2" role="tabpanel">
                  <form action="">
                    <textarea id="my-expressjs-tinymce-app">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Explicabo veniam omnis nostrum iste magni veritatis ipsa. Est, vitae totam. In ipsam fugiat reprehenderit, non officia quisquam earum? Mollitia sit ipsam placeat aut repellendus aperiam pariatur nostrum veritatis facilis, nam quam hic nobis numquam incidunt praesentium, ex exercitationem magnam nemo.
                      <table class="MsoTableGrid" border="1" cellspacing="0">
                        <tbody>
                        <tr>
                        <td valign="top" width="260">
                        <p class="MsoNormal" align="center"><strong>Lorem</strong></p>
                        </td>
                        <td valign="top" width="260">
                        <p class="MsoNormal" align="center"><strong>Ipsum</strong></p>
                        </td>
                        <td valign="top" width="261">
                        <p class="MsoNormal" align="center"><strong>Dolor</strong></p>
                        </td>
                        </tr>
                        <tr>
                        <td valign="top" width="260">
                        <p class="MsoNormal" align="center">Lorem ipsum dolor sit amet</p>
                        </td>
                        <td valign="top" width="260">
                        <p class="MsoNormal" align="center">262.630</p>
                        </td>
                        <td valign="top" width="261">
                        <p class="MsoNormal" align="center">consectetur adipisicing elit. </p>
                        </td>
                        </tr>
                        </tbody>
                        </table>
                    </textarea>
                    <div class="mt-4">
                      <button type="button" class="btn btn-primary hover-scale me-3 load-indicator" id="generate-pdf" onclick="generatePDF()">
                        <span class="indicator-label"> Preview </span>
                        <span class="indicator-progress">
                          Please wait... <span class="spinner-border spinner-border-sm align-middle"></span>
                        </span>
                      </button>
                      <button type="button" id="btnKirim" class="btn btn-info hover-scale me-3 load-indicator" onclick="sendPDF()">
                        <span class="indicator-label"> Kirim </span>
                        <span class="indicator-progress">
                          Please wait... <span class="spinner-border spinner-border-sm align-middle"></span>
                        </span>
                      </button>
                    </div>
                  </form>
                </div>

                <div class="tab-pane fade" id="kt_tab_pane_3" role="tabpanel">
                  .....
                </div>
              </div>


            </div>
            <div class="col-md-6 row-divider">
              <iframe id="pdfViewer" width="100%" height="940px"></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .row-divider {
    border-left: 1px solid #ccc;
    height: 100%;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.0/jspdf.umd.min.js"></script>
<script type="text/javascript" src="/dompurify/dist/purify.min.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.0.0-rc.7/dist/html2canvas.min.js"></script>
<!-- <script src="/jspdf/dist/jspdf.umd.min.js"></script> -->

<script>
  const btnPreview = document.querySelector("#generate-pdf");
  btnPreview.addEventListener("click", function() {
    btnPreview.setAttribute("data-kt-indicator", "on");
    setTimeout(function() {
      btnPreview.removeAttribute("data-kt-indicator");
    }, 3000);
  });
  const btnKirim = document.querySelector("#btnKirim");
  btnKirim.addEventListener("click", function() {
    btnKirim.setAttribute("data-kt-indicator", "on");
    setTimeout(function() {
      btnKirim.removeAttribute("data-kt-indicator");
    }, 3000);
  });

  function generatePDF() {
    event.preventDefault();

    const tahunIni = new Date().getFullYear();
    const dari = $('#dari').val();
    const kepada = $('#kepada').val();
    const sifat = $('#sifat').val();
    const perihal = $('#perihal').val();
    const jumlahLampiran = $("#jumlah-lampiran").val();
    const tipeLampiran = $("#tipe-lampiran").val();
    const lampiran = jumlahLampiran + " " + tipeLampiran;
    const isiSurat = tinymce.activeEditor.getContent();

    const valueNoAgenda = `<%= typeof lastNoAgenda !== 'undefined' && lastNoAgenda !== null ? lastNoAgenda.noAgenda + 1 : 1 %>`;
    const noAgenda = valueNoAgenda.toString().padStart(3, '0');
    const nomorNotaDinas = `${noAgenda}/<%= divisi %>/I/${tahunIni}`;
    // Create new PDF document
    window.jsPDF = window.jspdf.jsPDF;
    const doc = new jsPDF('p', 'pt', 'a4');

    //header logo
    const img = new Image();
    img.src = '/images/logo-500px.png';
    doc.addImage(img, 'png', 10, 10, 113, 85);

    const img2 = new Image();
    img2.src = '/images/logo-header.png';
    doc.addImage(img2, 'png', 360, 20, 200, 60);

    //garis
    const x = doc.internal.pageSize.getWidth() / 2;
    const panjangGaris = 550;
    const startX = x - (panjangGaris / 2);
    const endX = x + (panjangGaris / 2);

    doc.setLineWidth(1);
    doc.line(startX, 85, endX, 85);

    //body
    // garis
    const lineLength = 90;
    const startX2 = x - (lineLength / 2);
    const endX2 = x + (lineLength / 2);

    doc.setLineWidth(1);
    doc.line(startX2, 118, endX2, 118);

    doc.setFontSize(14);
    doc.setFont("Helvetica", "bold")
    doc.text(`NOTA DINAS`, x, 115, {
      align: "center"
    });
    doc.setFontSize(12);
    doc.setFont("Helvetica", "")
    doc.text(`Nomor : ${nomorNotaDinas}`, x, 135, {
      align: "center"
    });

    doc.text(`Kepada`, 72, 180, );
    doc.text(`Dari`, 72, 200, );
    doc.text(`Sifat`, 72, 220, );
    doc.text(`Lampiran`, 72, 240, );
    doc.text(`Hal`, 72, 260, );

    doc.text(`: ${kepada}`, 140, 180);
    doc.text(`: ${dari}`, 140, 200);
    doc.text(`: ${sifat}`, 140, 220);
    doc.text(`: ${lampiran}`, 140, 240);
    doc.text(`: ${perihal}`, 140, 260);

    const tandatangan = `
    <p>&nbsp;</p>
    <table style="border-collapse: collapse; width: 32.8323%; height: 39px; background-color: rgb(255, 255, 255); border: 1px hidden rgb(255, 255, 255); margin-right: 0px; margin-left: auto;" border="1"><colgroup><col style="width: 100%;"></colgroup>
      <tbody>
        <tr>
          <td style="border-width: 1px; border-color: rgb(255, 255, 255);">
            <p style="text-align: center;">Lorem Ipsum</p>
            <p style="text-align: center;">&nbsp;</p>
            <p style="text-align: center;">&nbsp;</p>
            <p style="text-align: center;">Daniel</p>
          </td>
        </tr>
      </tbody>
      </table>
    `;

    doc.html(isiSurat + tandatangan, {
      callback: function(doc) {
        const pdfViewer = document.getElementById("pdfViewer");
        pdfViewer.src = doc.output("datauristring");

        const out = doc.output();
        const url = 'data:application/pdf;base64,' + btoa(out);

        fetch('/notadinas/konsep', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              document: url,
              nomor: nomorNotaDinas
            })
          })
          .then(response => {
            console.log(response);
          })
          .catch(error => {
            console.error("error :" + error);
          });
      },
      margin: [300, 72, 72, 72],
      width: 450,
      windowWidth: 450,
    });
  }

  function sendPDF() {
    const tahun = new Date().getFullYear();
    const tanggal = new Date().toLocaleDateString('id-ID', {
      day: 'numeric',
      month: 'long',
      year: 'numeric',
    });
    const dari = $('#dari').val();
    const kepada = $('#kepada').val();
    const sifat = $('#sifat').val();
    const perihal = $('#perihal').val();
    const jumlahLampiran = $("#jumlah-lampiran").val();
    const tipeLampiran = $("#tipe-lampiran").val();
    const lampiran = jumlahLampiran + " " + tipeLampiran;

    const valueNoAgenda = `<%= typeof lastNoAgenda !== 'undefined' && lastNoAgenda !== null ? lastNoAgenda.noAgenda + 1 : 1 %>`;
    const noAgenda = valueNoAgenda.toString().padStart(3, '0');
    const noNotaDinas = `${noAgenda}/<%= divisi %>/I/${tahun}`;

    fetch('/notadinas/kirim', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          noNotaDinas,
          noAgenda,
          tanggal,
          tahun,
          dari,
          kepada,
          perihal,
          lampiran,
          // kodeMasalah,
          sifat,
          // keterangan,
          // email,s
          // divisi,
          // fileAttachment,
          flag: 1,
        })
      })
      .then(response => {
        console.log(response);
        if (response.ok) {
          console.log(response);
          Swal.fire("Berhasil", "Nota dinas berhasil dikirim", "success");
        } else {
          Swal.fire("Perhatian", "Bad request", "error");
          console.error(response);
        }
      })
      .catch(error => {
        console.error('Terjadi kesalahan:', error);
      });
  }

  $(document).ready(function() {
    window.jsPDF = window.jspdf.jsPDF;
    const doc = new jsPDF('p', 'pt', 'a4');
    //header
    //logo
    const img = new Image();
    img.src = '/images/logo-500px.png';
    doc.addImage(img, 'png', 10, 10, 113, 85);

    const img2 = new Image();
    img2.src = '/images/logo-header.png';
    doc.addImage(img2, 'png', 360, 20, 200, 60);

    //garis
    const x = doc.internal.pageSize.getWidth() / 2;
    const panjangGaris = 550;
    const startX = x - (panjangGaris / 2);
    const endX = x + (panjangGaris / 2);

    doc.setLineWidth(1);
    doc.line(startX, 85, endX, 85);

    //body
    // garis
    const lineLength = 90;
    const startX2 = x - (lineLength / 2);
    const endX2 = x + (lineLength / 2);

    doc.setLineWidth(1);
    doc.line(startX2, 118, endX2, 118);


    doc.setFontSize(14);
    doc.setFont("Helvetica", "bold")
    doc.text(`NOTA DINAS`, x, 115, {
      align: "center"
    });
    doc.setFontSize(12);
    doc.setFont("Helvetica", "")
    doc.text(`Nomor : .../.../.../2023`, x, 135, {
      align: "center"
    });

    doc.text(`Kepada`, 72, 180, );
    doc.text(`Dari`, 72, 200, );
    doc.text(`Sifat`, 72, 220, );
    doc.text(`Lampiran`, 72, 240, );
    doc.text(`Hal`, 72, 260, );

    const separatorWidth = 72;
    const separatorText = ':';

    doc.text(separatorText, 72 + separatorWidth, 180, null, null, 'right');
    doc.text(separatorText, 72 + separatorWidth, 200, null, null, 'right');
    doc.text(separatorText, 72 + separatorWidth, 220, null, null, 'right');
    doc.text(separatorText, 72 + separatorWidth, 240, null, null, 'right');
    doc.text(separatorText, 72 + separatorWidth, 260, null, null, 'right');

    const pdfViewer = document.getElementById("pdfViewer");
    pdfViewer.src = doc.output("datauristring");

  });
</script>



<%- include ../partials/footer.ejs %>
<%- include ../partials/js.ejs %>